# import resolution

This codebase relies on native [node esm resolution algorithm](https://nodejs.org/dist/latest-v16.x/docs/api/esm.html#esm_resolution_algorithm).

This is the native Node.js import resolution algorithm for ESM. There is important things to see regarding this algorithm:

- _self referencing_
- ESLint import resolution
- VSCode import resolution

## Self referencing

Amongst other things _node esm resolution algorithm_ allows something called _self referencing_ in your import paths. This is very useful to have consistent import paths and is easier to read than many `../../`.

```js
import { something } from "../../file.js"
// can be written
import { something } from "package-name/src/internal/file.js"
```

_self referencing_ is enabled by `"./*": "./*"` inside `"exports"` in our [package.json](../../package.json#L30). Read more on Node.js [documentation about self referencing](https://nodejs.org/dist/latest-v16.x/docs/api/packages.html#packages_self_referencing_a_package_using_its_name).

## ESLint import resolution

ESLint configuration enables a plugin named `"import"` in [.eslintrc.cjs](../../.eslintrc.cjs#L41). It also enables a rule to ensure all import paths can be resolved.

But at the time of writing this documentation, there is no ESLint import resolver implementing _node esm resolution algorithm_. Instead ESLint is configured to use an importmap file at line 48 in [.eslintrc.cjs](../../.eslintrc.cjs#L48).

This importmap file is named _importmap.dev.importmap_ and contains all the mapping necessary for _node esm resolution algorithm_. _importmap.dev.importmap_ is generated by `npm run generate-importmap` command.

## Auto and manual importmap file generation

Importmap file is generated after every `npm install` and can be generated on demand by `npm run generate-importmap`.

The `"postinstall"` script in [package.json](../../package.json#L59) is calling `npm run generate-importmap` but this is meant to happen only for the developers of the package. For this reason, _postinstall_ script is removed from _package.json_ before publishing on npm by the combination of two _scripts_ in the _package.json_: `"prepublishOnly"` and `"postpublish"`.

You should run `npm run generate-importmap` when something impacting _node esm resolution algorithm_ happens. It means when any of the following fields has changed in your _package.json_: `"name"`, `"imports"`, `"exports"`, `"dependencies"`, `"devDependencies"`.

In practice it happens in 3 scenarios:

1. You update manually `"name"`, `"imports"` or `"exports"` field.
2. You install a new dependency with `npm install <package-name>`
3. You uninstall a dependency with `npm uninstall <package-name>`

## VSCode import resolution

It is very valuable to help VSCode with import resolution so that <kbd>cmd</kbd>+`click` on a variable open the file where it is declared. It also improves VSCode autocompletion as it becomes aware of the code inside the imported file.

But at the time of writing this documentation, there is no VSCode extension implementing _node esm resolution algorithm_. Instead, a _jsconfig.json_ is generated for VSCode to make it capable to resolve import.

This is the responsability of `npm run generate-importmap` which is also generating a _jsconfig.json_ file to make VSCode aware of import mappings during import resolution.

## Symptoms when importmap should be regenerated

- `import/no-unresolved` ESLint rule will start failing on some imports.
  ![stuff](./eslint_import_error_vscode.png)

- <kbd>cmd</kbd>+`click` in VSCode won't work anymore on these imports.

# How to remove ESM resolution from ESLint and VSCode

1. Remove `"node ./script/publish/remove_postinstall.mjs && "` from `"prepublishOnly"` in [package.json](../../package.json#L60)
2. Remove `"postpublish"`, `"postinstall"` and `"generate-importmap"` from `"scripts"` in [package.json](../../package.json#L46)
3. Delete [script/importmap/](../../script/importmap/) directory
4. Replace `"import/resolver"` in [.eslintrc.cjs](../../.eslintrc.cjs#L43)

   ```diff
   - "@jsenv/importmap-eslint-resolver": {
   -   projectDirectoryUrl: __dirname,
   -   importMapFileRelativeUrl: "./importmap.dev.importmap",
   -   node: true,
   - },
   + "node": {}
   ```

   This step means ESLint will now resolve import using [CommonJS resolution algorithm](https://nodejs.org/dist/latest-v16.x/docs/api/modules.html#modules_all_together) instead of importmap.

5. Remove `"@jsenv/importmap-eslint-resolver"` from `"devDependencies"` in [package.json](../../package.json#L69)
6. Remove `/importmap.dev.importmap` in [.gitignore](../../.gitignore#L23)
7. Delete `./importmap.dev.importmap`
8. Remove `"paths"` from `./jsconfig.json`
